qs=stocklist.annotate(prev_close=Window(expression=Lag('close'),partition_by=F("stock_id"),order_by=F('date').asc(),)).annotate(prev_high=Window(expression=Lag('high'),partition_by=F("stock_id"),order_by=F('date').asc(),)).annotate(prev_low=Window(expression=Lag('low'),partition_by=F("stock_id"),order_by=F('date').asc(),)).annotate(prev_open=Window(expression=Lag('open'),partition_by=F("stock_id"),order_by=F('date').asc(),))annotate(prev_volume=Window(expression=Lag('volume'),partition_by=F("stock_id"),order_by=F('date').asc(),)).annotate(diff=F('close')-F('prev_close')).annotate(per_chan=Round(F('diff')/F('prev_close')*100, 2)).annotate(diffvolume=F('volume')-F('prev_volume')).annotate(vol_change=Round(F('diffvolume')/F('prev_volume')*100, 2)).annotate(engulf=Case(When(Q(prev_high__lt=F('high')) & Q (prev_open__lt=F('open')) & Q(prev_close__gt=F('close')) & Q (prev_low__gt=F('low')) & Q(prev_volume__lt=F('volume')) ,then=Value("Yes")),defalut=Value("No"))).filter(date__gte='2022-05-26')



qs.annotate(engulf=Case(When(Q(prev_high__lt=F('high')) & Q (prev_open__lt=F('open')) & Q(prev_close__gt=F('close')) & Q (prev_low__gt=F('low')) & Q(prev_volume__lt=F('volume')) ,then=Value("Yes")),defalut=Value("No")))

qs.annotate(engulf=Case(When(Q(prev_high__gt=F('high')),then=Value("Yes")),defalut=Value("No")))